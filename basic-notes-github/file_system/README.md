# 挂载

- 基于Linux中一切皆文件（硬件设备也是文件）的理念，挂载指的是将设备文件中的顶级目录连接到Linux根目录下的某一目录（最好是空目录），访问此目录就等同于访问设备文件



#### Linux系统使用任何硬件设备，都必须将设备文件与已有目录文件进行挂载



# 文件管理系统

### 磁盘在格式化时，会被分成三个存储区域：超级块、索引节点和数据块区

#### 1、超级块：用来存储文件系统的详细信息，比如块个数、索引节点区和数据块

#### 2、索引节点区：用来从存储索引节点

#### 3、数据块区：用来存储文件数据或者目录数据



#### **超级块：** 文件系统挂载时进入内存

#### **索引节点：** 文件被访问时进入内存



# 虚拟文件系统

### 文件系统种类众多，操作系统希望对用户提供一个统一的接口，于是在用户层与文件系统层引入了中间层，这个中间层被称为虚拟文件系统



# 文件的使用

#### 操作系统会跟踪进程打开的所有文件，即操作系统为每个进程维护一个文件表，文件表里的每一项代表一个文件描述符。



### 注意两个不同的视角： 

### 1、用户视角下，文件是一个持久化的数据结构，用户习惯以字节的方式读写文件

### 2、操作系统视角下，文件需要与数据块对应，操作系统以数据块来读写文件



### 文件系统会屏蔽这种差异，文件系统的基本操作单位是数据块



# 文件的存储

### 数据在磁盘上的存放方式：

### 1、连续空间存放方式

- 文件的数据紧密相连，读写效率高，一次磁盘寻址即可读出整个文件
- 局限：存在磁盘空间碎片、文件长度不易扩展的缺陷

### 2、非连续空间存放方式

#### 2.1链表方式

- 链表的方式存放是离散的、不需要连续的，可以消除磁盘碎片，提高磁盘空间的利用率，同时，文件的长度可以动态扩展。
- 局限：不能有效支持直接访问

#### 2.2索引方式

- 索引的实现是为每个文件创建一个“索引数据块”，里面存放指向文件数据块的指针列表，同时，文件头需要包含指向“索引数据块”的指针，这样可以通过文件头知道索引数据块的位置，再通过索引数据块里的索引信息找到对应的数据块。
- 索引方式的优点：文件的创建、增大、缩小很方便，不会有碎片的问题，同时支持顺序读写和随机读写
- 局限：存储索引带来的额外内存开销

#### 2.3链表+索引方式

- 在索引数据块留出一个存放下一个索引数据块的指针，于是当下一个索引数据块的索引信息用完，就可以通过指针方式找到下一个索引数据块信息
- 多级索引块



### Unix文件存放方式：

- 如果存放文件所需的数据块小于 10 块，则采用直接查找的方式

- 如果存放文件所需的数据块超过 10 块，则采用一级间接索引方式
- 如果前面两种方式都不够存放大文件，则采用二级间接索引方式
- 如果二级间接索引也不够存放大文件，这采用三级间接索引方式



# 空闲空间管理

文件的存储是针对已经被占用的数据块的组织和管理

而针对磁盘的空闲空间也是要引入管理的机制

#### 空闲表法

- 为所有空闲空间建立一张表，表内容包括空闲区的第一个块号和该空闲区的块个数，该方式是连续分配
- 局限：当存储空间中存在大量小的空闲区时，空闲表会变得很大，查询效率会很低。

#### 空闲链表法

- 使用链表的方式来管理内存空间，每一个空闲块里有一个指针指向下一个空闲块
- 局限：由于链表的特性，不能随即访问，工作效率较低

#### 位图法

- 位图法：利用二进制的一位来表示磁盘中一个盘块的使用情况，磁盘上所有的盘块都有一个二进制位与之对应
- Linux文件系统即采用了位图的方式来管理空闲空间



---

Linux用户在创建一个新文件时，Linux内核会通过inode的位图找到空闲可用的inode，并进行分配。要存储数据时，会通过块的位图找到空闲的块分配给数据

---



# 文件系统的结构

- 块组



# 目录的存储

目录本质也是一个文件，普通文件的块里面保存的是文件数据，而目录文件的块里面保存的是目录里面一项一项的文件信息

- 保存目录的格式采用哈希表，对文件名进行哈希计算，把哈希值保存。
  - 优点：查找迅速，插入和删除简单
    - 局限：需要采取措施避免哈希冲突



# 软链接和硬链接

#### 硬链接是多个目录项的“索引节点指针”指向同一个“索引节点”

- 硬链接是不可用于跨文件系统的
- 由于多个目录项都是指向一个索引节点的，那么只有删除文件的所有硬链接以及源文件时，系统才会彻底删除该文件



### 软链接

#### 软链接相当于创建了一个文件，这个文件具有独立的索引节点，但是这个文件的内容是那个原文件的路径

- 软链接是可以跨文件系统的
- 当原文件被删除后，软链接文件还在，只是文件内容对应的地址处不再存在所需文件















