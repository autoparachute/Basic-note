# 内存管理

### 单片机是没有操作系统的，单片机的 CPU 是直接操作内存的「物理地址」

### 进程->虚拟内存->物理内存

### 程序所使用的内存地址叫做虚拟内存地址（Virtual Memory Address）

### 实际存在硬件里面的空间地址叫物理内存地址（Physical Memory Address）

## 虚拟内存

### 操作系统引入了虚拟内存，进程持有的虚拟地址会通过 CPU 芯片中的内存管理单元（MMU）的映射关系，来转换变成物理地址，然后再通过物理地址访问内存

## 内存分段

### 程序是由若干个逻辑分段组成的，如可由代码分段、数据分段、栈段、堆段组成。不同的段是有不同的属性的，所以就用分段（Segmentation）的形式把这些段分离出来。

### 分段机制下的虚拟地址由两部分组成：段选择子和段内偏移量，段选择子里最重要的是段号，用作段表的索引。段表里保存的是这个段的基地址、段界限以及特权等级

### 即虚拟地址到物理地址的映射是通过段表实现的

### 内存分段的不足：1、内存碎片	2、内存交换的效率低

### 解决内存碎片的问题是内存交换(Linux系统的Swap空间即用于内存和硬盘的空间交换)

## 内存分页

### 分页是把整个虚拟和物理内存空间切成一段段固定尺寸的大小。这样一个连续并且尺寸固定的内存空间，我们叫页（Page）。在 Linux 下，每一页的大小为 4KB

### 即虚拟地址到物理地址的映射是通过页表实现的

### 如果内存空间不够，操作系统会把其他正在运行的进程中的「最近没被使用」的内存页面给释放掉，也就是暂时写在硬盘上，称为换出（Swap Out）。一旦需要的时候，再加载进来，称为换入（Swap In）。所以，一次性写入磁盘的也只有少数的一个页或者几个页，不会花太多时间，内存交换的效率就相对比较高

### 分页的方式使得我们在加载程序的时候，不再需要一次性都把程序加载到物理内存中。我们完全可以在进行虚拟内存和物理内存的页之间的映射之后，并不真的把页加载到物理内存里，而是只有在程序运行中，需要用到对应虚拟内存页里面的指令和数据时，再加载到物理内存里面去

### 在分页机制下，虚拟地址分为两部分：页号和页内偏移。页号作为页表的索引，页表包含物理页每页所在物理内存的基地址。这个基地址与页内偏移的组合就形成了物理内存地址

### 简单的页表存在空间上的缺陷，为了解决页表项过多占用空间的问题，需要采用多级页表

### 基于局部性原理，每个进程都有 4GB 的虚拟地址空间，而显然对于大多数程序来说，其使用到的空间远未达到 4GB，因为会存在部分对应的页表项都是空的，根本没有分配，对于已分配的页表项，如果存在最近一定时间未访问的页表，在物理内存紧张的情况下，操作系统会将页面换出到硬盘，也就是说不会占用物理内存。

### 一级页表就可以覆盖整个 4GB 虚拟地址空间，但如果某个一级页表的页表项没有被用到，也就不需要创建这个页表项对应的二级页表了，即可以在需要时才创建二级页表。

### 多级页表，至少需要满足覆盖整个虚拟地址空间，故一级页表依然需要全覆盖

### 基于局部性原则，二级分页可以推广到多级页表，通过对局部性原则的充分利用，页表占用的空间被有效降低

### 多级页表只是解决了空间上的页表缺陷，但是页表的分级使得虚拟地址到物理地址的转换更为复杂，带来了时间上的开销。为了一定程度上减少时间开销，依旧利用局部性原则，将最常被访问的一部分页表存放在Cache中，即成为TLB(Translation Lookaside Buffer)，有了TLB后，CPU在寻址时会先查找TLB，如果没找到，才会查询常规页表。

## 段页式内存管理

### 内存分段和内存分页可以组合起来在同一个系统中使用，通常称为段页式内存管理

### 1、将程序划分为多个有逻辑意义的段		2、把每个段划分为多个页，即对分段划分出来的连续空间再划分固定大小的页

### 虚拟地址结构由段号、段内页号和页内偏移量三部分组成

### 段页式地址变换中要得到物理地址必须经过三次内存访问：1、第一次访问段表，得到页表的起始地址	2、第二次访问页表，得到物理页号		3、第三次将物理页号与页内偏移组合，计算得到物理地址

## Linux内存管理

### intel 80386完善了段式内存管理的同时还实现了页式内存管理,逻辑地址->线性地址->物理地址

### 因为 Intel X86 CPU 一律对程序中使用的地址先进行段式映射，然后才能进行页式映射。既然 CPU 的硬件结构是这样，Linux 内核也只好服从 Intel 的选择。但是事实上，Linux 内核所采取的办法是使段式映射的过程实际上不起什么作用

